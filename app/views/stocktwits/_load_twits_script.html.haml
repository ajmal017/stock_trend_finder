:coffee
  loading = false
  nomore = false

  $last_twit_id = () -> $('table.stocktwits tr').filter(':last').attr('id')
  $symbol_filter = () -> $('#stocktwits-filter-indicator').attr('data-symbol')

  load_next = (symbol, last_id) ->
    loading = true
    $('.last-twit-placeholder').show()
    $.post '/stocktwits/load_twits' \
      , { symbol: symbol, max: last_id } \
      , (data) ->
        if data.length > 0
           if $('table.stocktwits tr').filter(':last').length > 0
             $('table.stocktwits tr').filter(':last').after(data)
           else
             $('#stocktwits-content table.stocktwits').append(data)
        else
          nomore = true
        $('.last-twit-placeholder').hide()
        loading = false

  set_symbol_filter = (symbol) ->
    $('#stocktwits-content table.stocktwits').empty()
    $('#stocktwits-filter-indicator').attr('data-symbol', symbol)
    $('#stocktwits-filter-indicator').text(symbol)
    nomore = false
    load_next($symbol_filter, null)

  set_watching_icon = () ->
    $.getJSON '/stocktwits/watching.json', {symbol: $symbol_filter}, (data) ->
      if data.watching
        $('img.stocktwits-watch-indicator').attr('src', '/assets/icon-star-sm-yellow.png')
      else
        $('img.stocktwits-watch-indicator').attr('src', '/assets/icon-star-sm-grey.png')
      $('img.stocktwits-watch-indicator').show()

  $('a.symbol-filter-link').click () ->
    symbol = $(this).attr('data-symbol')
    set_symbol_filter(symbol)
    set_watching_icon()
    false

  $('a#toggle-watching').click () ->
    console.log($.get('/stocktwits/toggle_watching', {symbol: $symbol_filter}))
    set_watching_icon()
    false

  $(window).scroll () ->
    if $(window).scrollTop() >= $('#stocktwits-content').height() - $(window).height() - 500
      if !loading && !nomore
        load_next($symbol_filter, $last_twit_id)